language: generic

services:
  - docker

before_install:
  - ./run gcloud-config
  - ./run gcloud-activate-service-account

jobs:
  include:
    - stage: Build
      script:
        - ./run build
        - ./run gsutil cp -r build "gs://convenience-assets/$(./run get-version)/$(./run githash-short)/build"
    - stage: Test
      script:
        - ./run test
    - stage: Deploy
      script:
        - ./run gsutil cp -r "gs://convenience-assets/$(./run get-version)/$(./run githash-short)/build" build
        - ./run deploy
    - stage: Release
      script:
        - ./run gsutil cp -r "gs://convenience-assets/$(./run get-version)/$(./run githash-short)/build" build
        - ./run release

stages:
  - Build
  - Test
  - name: Deploy
    if: (NOT type IN (pull_request)) AND (branch = master)
  - name: Release
    if: (NOT type IN (pull_request)) AND (branch = master)
